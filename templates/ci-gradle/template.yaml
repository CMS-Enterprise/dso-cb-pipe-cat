version: 1
type: pipeline-template
templateType: MULTIBRANCH
name: gradle CI Pipeline Job
description: Simple JAVA(Ver 11/17) APP with Gradle
parameters:
  - name: emailRecipient
    type: string
    displayName: Email address to be used for sending build notifications
  - name: github_repo
    type: string
    displayName: GitHub HTTPS repo endpoint
  - name: artifact_name
    type: string
    displayName: Name of your artifact in Artifactory
  - name: artifactory_project_name
    type: string
    displayName: Name of your project in Artifactory
  - name: java_version
    type: string
    displayName: Java version
  - name: build_args
    type: string
    displayName: Gradle Build arguments
  - name: test_args
    type: string
    displayName: Gradle Test arguments
  - name: gradle_build_path
    type: string
    displayName: Path and name of the build.gradle file
  - name: gh_org
    type: string
    displayName: Name of your Github Org
  - name: work_directory
    type: string
    displayName: Name of the working directory
  - name: sq_project_key
    type: string
    displayName: Sonarqube project key
  - name: org_id
    type: string
    displayName: Snyk org id
  - name: docker_args
    type: string
    displayName: Docker arguments
  - name: artifactory_path
    type: string
    displayName: path to artifactory in artifactory 
  - name: docker_file
    type: string
    displayName: Name of the Docker file
   
# DIDN'T WORK
# multibranch:
#   branchSource:
#     github:
#       repoOwner: ${gh_org}
#       repository: ${github_repo}
#       credentialsId: "git_token"
#       includes:
#         - gradle-java11-std
#   orphanedItemStrategy:
#     daysToKeep: 3

# DIDN'T WORK
# multibranch:
#   branchSource:
#     git:
#       remote: 'https://github.com/${gh_org}/${github_repo}.git'
#       credentialsId: "git_token"
#       traits:
#         - gitBranchDiscovery
#         - $class: DiscoverOtherRefsTrait
#           ref: 'heads/gradle-java11-std'
#         - cleanBeforeCheckout
#     strategy:
#       $class: NamedExceptionsBranchPropertyStrategy
#       namedExceptions:
#         - name: "gradle-java11-std"
#       defaultProperties:
#         - $class: NoTriggerBranchProperty
#     buildStrategies:
#       - $class: SkipInitialBuildOnFirstBranchIndexing
#   orphanedItemStrategy:
#     daysToKeep: 3

multibranch:
  branchSource:
    git:
      remote: 'https://github.com/${gh_org}/${github_repo}.git'
      credentialsId: "git_token"
      traits:
        - $class: "jenkins.plugins.git.traits.BranchDiscoveryTrait"  # Discover branches
        - $class: "jenkins.plugins.git.traits.CleanBeforeCheckoutTrait"  # Clean before checkout
        - $class: "jenkins.scm.impl.trait.RegexSCMHeadFilterTrait"  # Use regex to include only the specified branch
          regex: 'refs/heads/gradle-java11-std'
    # Keep the strategy this is awesome, it stops the pipelines from running everytime we update the catalog
    # Doesn't keep the branches from getting pulled tho
    strategy:
      # $class: NamedExceptionsBranchPropertyStrategy
      # namedExceptions:
      #   - name: "gradle-java11-std"
      defaultProperties:
        - $class: NoTriggerBranchProperty
    buildStrategies:
      - $class: SkipInitialBuildOnFirstBranchIndexing
  orphanedItemStrategy:
    daysToKeep: 3