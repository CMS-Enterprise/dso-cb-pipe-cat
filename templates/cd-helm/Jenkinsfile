def Map properties=[
    tech: "${tech}",
    testArgs: "${test_args}",
    ghOrg: "${gh_org}",
    githubBranch: "${github_branch}",
    githubRepo: "${github_repo}",
    adoIAMRole: "${ado_iam_role}",
    deploy: [
        artifactoryPath: "${artifactory_path}",
        workDir: "${work_directory}"
    ]
] 
@Library("dso-shared-lib@main") _
def podYaml = libraryResource "podTemplates/helm-agent.yaml"
pipeline {
    agent{
        kubernetes {
            yaml podYaml
        }
    }
    stages{
        stage('GitHub Checkout') {
            steps {
              git credentialsId: "git_token", url: "${github_repo}", branch: "${github_branch}"
            }
        }
        stage ("init"){
            steps {
                container ("jnlp"){
                    sh "echo init"
 //                       init()
                }
            }
        }
        stage ("helm deploy") {
            steps {
                container ("jnlp") {
                    sh "echo helm deploy"
                } 
            }
        }
        stage ("post-deploy maven test") {
            when { expression { tech.contains("maven") }}
            steps {
                container ("maven") {
                    script{ 
                        maven.test(properties.testArgs)
                    }
                }
            }
        }
        stage ("post-deploy dotnet test") {
            when { expression { tech.contains("dotnet") }}
            steps {
                container ("dotnet") {
                    script {
                        dotnet.test(properties.testArgs)
                    }
                }
            }
        }
    }
}